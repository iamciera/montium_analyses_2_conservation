 ---
title: "TFBS_visualization"
author: "Ciera Martinez"
date: "July 10, 2017"
output: pdf_document
---

**Purpose**: The purpose is to prototype 
1. what type of analysis I can do with the data set I have created. 
2. see what else in terms of information / data I need to collect.

### Set up 
```{r}
## Libraries
library(ggplot2)
library(grid)
library(dplyr)
library(reshape2)
library(stringr)
library(cowplot)
```

This is contiued on from 0.visualization_TFBS_clean.Rmd.

# Visualization
## To-Do

[x] Need Phastcons score. 
[x] Keys to Phastcons score.
[ ] Need to zoom in 
[ ] Build Shiny app
[x] Attach positive and negative presence in insitu
[ ] Bring in new TFBS


```{r}
## PhastCons - cons_score
cons_scores <- read.csv("../data/outputs/sub_cons_score_13August2017.csv")
head(cons_scores)


## PhastCons - most conserved
most_conserved <- read.csv("../data/outputs/sub_most_conserved_clean_13August2017.csv")
levels(most_conserved$alignment_file) #there are less than 500 levels because not all the files had conserved regions
head(most_conserved)

## TFBS and Kvon expression data
## Takes ~4 min to load
TFBS_df <- read.csv("../data/outputs/combined_TFBS_kvon_13August2017.csv")
levels(as.factor(TFBS_df$alignment_file)) #500
levels(as.factor(TFBS_df$motif_file))

TFBS_df$positive_GAL4_anyStage <- gsub("1", "yes", TFBS_df$positive_GAL4_anyStage)
TFBS_df$positive_GAL4_anyStage <- gsub("0", "no", TFBS_df$positive_GAL4_anyStage)

head(TFBS_df)
```

Actual plotting.

```{r}
TFBS_df %>% filter(alignment_file == randomFile, score > 6) %>% 
  ggplot(., aes(align_position, species, size = score, color = motif_file)) +
    geom_point(alpha = .3) + 
    facet_grid(strand~.) +
    theme_bw() +
    theme(text = element_text(size = 20)) 

plot2 <- cons_scores %>% filter(alignment_file == "VT62738") %>% 
  ggplot(., aes(raw_MEMB002A_pos, post.prob)) + 
    geom_line() +
    theme_bw()
```

Random Plot


```{r}

## Make a list of all the alignment_files available
alignmentTypes <- levels(TFBS_df$alignment_file)

#############
randomFile <- sample(alignmentTypes, 1)

TFBS_sub <- subset(TFBS_df, alignment_file == randomFile & score > 6)
head(TFBS_sub)

rect_sub <- subset(most_conserved, alignment_file == randomFile)

rects <- data.frame(xstart = rect_sub$align_start[1:nrow(rect_sub)], xend = rect_sub$align_end[1:nrow(rect_sub)])

myTitle <- paste0("\n ID:", TFBS_sub$alignment_file[1], "\n GAL4 expression: ", TFBS_sub$positive_GAL4_anyStage[1], "\n DNAse Peaks: ", TFBS_df$DNase_Peaks_sumStages[1], "\n")

plot1 <- ggplot(TFBS_sub, aes(align_position, species, size = score, color = motif_file)) +
    geom_point(alpha = .2) +
    facet_grid(strand~.) +
    geom_point(alpha = .4) +
    theme_bw() +
    annotate("rect", xmin = rects$xstart, xmax = rects$xend, ymin = -Inf, ymax = Inf, alpha = .2) +
    labs(title = myTitle) +
    theme(text = element_text(size = 20),
          legend.position = "top",
          legend.box = "vertical",
          legend.box.just = "left",
          legend.justification = c(0,1),
          axis.text.x = element_blank()) +
     labs(x = "") +
  guides(colour = guide_legend(override.aes = list(size=10)))
  
plot2 <- cons_scores %>% filter(alignment_file == randomFile) %>% 
  ggplot(., aes(align_position, post.prob)) + 
    geom_line() +
    theme_classic() +
    theme(text = element_text(size = 20)) 

plot_grid(plot1, plot2, labels = c("A", "B"), nrow = 2, ncol = 1, align = "v", axis = "l", rel_heights = c(1, .4))

```